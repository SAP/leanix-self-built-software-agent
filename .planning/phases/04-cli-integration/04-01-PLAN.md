---
phase: 04-cli-integration
plan: 01
type: execute
---

<objective>
Add CLI flags for user-provided context and wire them through the discovery workflow.

Purpose: Enable users to override default context file locations via command-line options, completing the CLI integration for the context system.
Output: Working `--org-context` and `--repo-context` flags on the discover command with context info displayed in output.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency chain):
@.planning/phases/01-context-model/01-01-SUMMARY.md
@.planning/phases/02-context-discovery/02-01-SUMMARY.md
@.planning/phases/03-agent-integration/03-01-SUMMARY.md

# Key files to modify:
@src/cli/discover.py
@src/nodes/runnables/load_context_runnable.py
@src/services/context_loader.py
@src/dto/state_dto.py

**Tech stack available:**
- Click 8.2.1+ for CLI (established patterns in discover.py)
- Rich for console output
- Existing context loader with override support

**Established patterns:**
- Click options with type=click.Path() for file paths
- RootRepoState carries data through workflow
- build_discovery_context() already accepts org_context_override and repo_context_override

**Constraining decisions:**
- Phase 2: CLI override path marked as `<cli-override>` for debugging
- Phase 2: Context loader already supports override parameters
- Phase 3: Context flows through state.discovery_context
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --org-context and --repo-context CLI options</name>
  <files>src/cli/discover.py</files>
  <action>
Add two new Click options to the discover command:

1. `--org-context` option:
   - type=click.Path(exists=True, dir_okay=False, readable=True)
   - help='Path to organization context file (overrides ~/.sbs-discovery/{org}.md)'

2. `--repo-context` option:
   - type=click.Path(exists=True, dir_okay=False, readable=True)
   - help='Path to repository context file (overrides .sbs-discovery.md in repo)'

Add these parameters to the discover function signature (org_context: Optional[str], repo_context: Optional[str]).

Place options after --llm option to group context-related flags together.

Read file contents when provided (Path objects need .read_text()) and store for passing to workflow.
  </action>
  <verify>Run `python -m src.cli.main discover --help` and verify both --org-context and --repo-context appear in help output with correct descriptions</verify>
  <done>Help output shows both context options with path validation</done>
</task>

<task type="auto">
  <name>Task 2: Wire CLI context overrides through workflow state</name>
  <files>src/dto/state_dto.py, src/nodes/runnables/load_context_runnable.py, src/cli/discover.py</files>
  <action>
The context loader already supports overrides, but they need to flow from CLI to the runnable.

1. In src/dto/state_dto.py - Add two new optional fields to RootRepoState:
   - org_context_override: Optional[str] = None
   - repo_context_override: Optional[str] = None
   These carry CLI-provided content through the workflow.

2. In src/cli/discover.py - When creating initial_state:
   - Read file contents if org_context or repo_context paths provided
   - Set state.org_context_override and state.repo_context_override with the content

3. In src/nodes/runnables/load_context_runnable.py - Update load_context_runnable:
   - Pass state.org_context_override to build_discovery_context()
   - Pass state.repo_context_override to build_discovery_context()
   - The build_discovery_context function already handles these parameters

Do NOT modify context_loader.py - it already has the override logic.
  </action>
  <verify>
Add a test context file, run discover with --org-context pointing to it:
```bash
echo "# Test Context" > /tmp/test-context.md
python -m src.cli.main discover --repo SAP/ai-sdk-js --org-context /tmp/test-context.md --dry-run --limit 1
```
Check logs show "Using CLI-provided organization context override"
  </verify>
  <done>CLI overrides flow through state to context loader, logs confirm override usage</done>
</task>

<task type="auto">
  <name>Task 3: Display loaded context info in CLI output</name>
  <files>src/cli/discover.py</files>
  <action>
After the workflow processes each repository, display context loading info using Rich console.

1. After `pred_state = coerce_state(response)`, check if discovery_context exists on pred_state

2. If context was loaded, display info before the repo status:
   ```python
   if pred_state.discovery_context:
       ctx = pred_state.discovery_context
       if ctx.org_context_path:
           console.print(f"  [dim]Org context:[/dim] {ctx.org_context_path}")
       if ctx.repo_context_path:
           console.print(f"  [dim]Repo context:[/dim] {ctx.repo_context_path}")
   ```

3. Only show if at least one context was loaded (don't clutter output with "no context" messages)

Keep output concise - just the paths, not full content. Use [dim] style to not distract from main results.
  </action>
  <verify>
Create test context files and run discover:
```bash
mkdir -p ~/.sbs-discovery
echo "# SAP org context" > ~/.sbs-discovery/SAP.md
python -m src.cli.main discover --repo SAP/ai-sdk-js --dry-run
```
Verify output shows "Org context: ~/.sbs-discovery/SAP.md" line
  </verify>
  <done>Context file paths displayed in CLI output when context is loaded</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m src.cli.main discover --help` shows both context options
- [ ] `--org-context /path/to/file.md` reads and passes content to workflow
- [ ] `--repo-context /path/to/file.md` reads and passes content to workflow
- [ ] Invalid paths produce Click validation error (file not found)
- [ ] Context paths displayed in output when context is loaded
- [ ] Existing functionality unchanged when no context flags provided
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No regressions in discover command behavior
- Context overrides work end-to-end from CLI to agent prompts
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-integration/04-01-SUMMARY.md`
</output>
