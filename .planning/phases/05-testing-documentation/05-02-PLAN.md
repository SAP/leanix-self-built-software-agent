---
phase: 05-testing-documentation
plan: 02
type: execute
---

<objective>
Write integration tests for context loader service with filesystem mocking.

Purpose: Ensure context discovery from files works correctly under various conditions.
Output: Comprehensive tests for load_org_context, load_repo_context, and build_discovery_context.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Prior phase summary:
@.planning/phases/02-context-discovery/02-01-SUMMARY.md

# Source file to test:
@src/services/context_loader.py

**Tech stack available:** Python 3.13+, pytest, pytest-cov, tmp_path fixture
**Established patterns:**
- File loading returns tuple: (content, path) or (None, None)
- CLI overrides marked with `<cli-override>` path
- Debug-level logging for missing files (expected case)
- Graceful error handling for permission errors and OSError
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create context loader test file with fixture setup</name>
  <files>tests/services/test_context_loader.py</files>
  <action>
Create test file with fixtures for:
- tmp_path based org context directory (mock ~/.sbs-discovery/)
- tmp_path based repo directory with .sbs-discovery.md
- Sample context content strings

Use monkeypatch to override ORG_CONTEXT_DIR constant during tests.

Test load_org_context:
- Returns (content, path) when file exists
- Returns (None, None) when file missing
- Returns (None, None) when org_name is empty
- Handles PermissionError gracefully (returns None, None)
  </action>
  <verify>uv run pytest tests/services/test_context_loader.py -v -k "load_org"</verify>
  <done>4+ tests for load_org_context, all passing</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for load_repo_context and build_discovery_context</name>
  <files>tests/services/test_context_loader.py</files>
  <action>
Add tests for load_repo_context:
- Returns (content, path) when .sbs-discovery.md exists in repo
- Returns (None, None) when file missing
- Returns (None, None) when local_path is empty
- Handles read errors gracefully

Add tests for build_discovery_context:
- Builds context with both org and repo files present
- Builds context with only org file
- Builds context with only repo file
- Builds empty context when no files exist
- CLI override bypasses file loading (org_context_override)
- CLI override bypasses file loading (repo_context_override)
- Override path is set to `<cli-override>` when using overrides
  </action>
  <verify>uv run pytest tests/services/test_context_loader.py -v</verify>
  <done>10+ total tests covering all context loader functions</done>
</task>

</tasks>

<verification>
```bash
uv run pytest tests/services/ -v --cov=src/services/context_loader --cov-report=term-missing
```
All tests pass with good coverage of context_loader.py.
</verification>

<success_criteria>
- tests/services/test_context_loader.py created
- load_org_context fully tested (happy path + edge cases)
- load_repo_context fully tested
- build_discovery_context fully tested including CLI overrides
- All tests pass
- Coverage > 80% for context_loader.py
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-documentation/05-02-SUMMARY.md`:

# Phase 5 Plan 2: Context Loader Tests Summary

**[Integration tests for context discovery with filesystem mocking]**

## Performance
- Duration: X min
- Tasks: 2
- Files modified: 1

## Accomplishments
- [List test scenarios covered]

## Task Commits
1. Task 1: [commit hash] - load_org_context tests
2. Task 2: [commit hash] - load_repo_context and build_discovery_context tests

## Files Created
- tests/services/test_context_loader.py - Context loader integration tests

## Coverage
- context_loader.py: X% line coverage

## Next Step
Ready for 05-03-PLAN.md (documentation)
</output>
