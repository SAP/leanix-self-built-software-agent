---
phase: 05-testing-documentation
plan: 01
type: tdd
domain: python-testing
---

<objective>
Set up pytest and write tests for core context pure functions using TDD.

Purpose: Establish test infrastructure and ensure context model functions are correct via TDD discipline.
Output: Working pytest setup with tests for merge_contexts, _extract_org_from_url, and format_context_for_prompt.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Prior phase summaries (context system implementation):
@.planning/phases/01-context-model/01-01-SUMMARY.md
@.planning/phases/02-context-discovery/02-01-SUMMARY.md

# Source files to test:
@src/dto/context_dto.py
@src/nodes/runnables/load_context_runnable.py
@src/utils/context_injection.py

**Tech stack available:** Python 3.13+, pytest (to be added), structlog
**Established patterns:** Arrange/Act/Assert, pytest fixtures, class-based test organization
**Constraining decisions:**
- merge_contexts uses string concatenation with headers (repo after org for LLM recency weighting)
- _extract_org_from_url supports both HTTPS and SSH GitHub URL formats
- format_context_for_prompt has 4000 char limit with truncation marker
</context>

<feature>
  <name>Pure Function Tests (TDD)</name>
  <files>tests/conftest.py, tests/test_context_dto.py, tests/test_context_injection.py, tests/test_load_context_runnable.py</files>
  <behavior>
    **merge_contexts behavior:**
    - (None, None) → ""
    - ("org", None) → "org"
    - (None, "repo") → "repo"
    - ("org", "repo") → "## Organization Context\norg\n\n## Repository Context\nrepo"
    - ("  ", "  ") → "" (whitespace only treated as empty)

    **_extract_org_from_url behavior:**
    - "https://github.com/myorg/myrepo" → "myorg"
    - "https://github.com/myorg/myrepo.git" → "myorg"
    - "git@github.com:myorg/myrepo.git" → "myorg"
    - "" → None
    - "https://gitlab.com/org/repo" → None (non-GitHub)
    - "invalid-url" → None

    **format_context_for_prompt behavior:**
    - None → ""
    - DiscoveryContext(merged_context=None) → ""
    - DiscoveryContext(merged_context="content") → formatted string with header
    - DiscoveryContext(merged_context="x" * 5000) → truncated at 4000 chars with marker
  </behavior>
  <implementation>
    RED phase:
    1. Add pytest and pytest-cov to dev dependencies
    2. Create tests/conftest.py with basic fixtures
    3. Write failing tests for all behaviors above

    GREEN phase:
    4. Tests should pass (functions already implemented)
    5. If any fail, investigate - may indicate bug in implementation

    REFACTOR phase:
    6. Clean up test organization if needed
  </implementation>
</feature>

<verification>
```bash
uv run pytest tests/ -v
```
All tests pass.
</verification>

<success_criteria>
- pytest added to dev dependencies
- tests/conftest.py created with basic fixtures
- tests/test_context_dto.py covers merge_contexts
- tests/test_load_context_runnable.py covers _extract_org_from_url
- tests/test_context_injection.py covers format_context_for_prompt
- All tests pass
- 2-3 commits: test setup, test implementations
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-documentation/05-01-SUMMARY.md`:

# Phase 5 Plan 1: Pure Function Tests Summary

**[What was tested and results]**

## Performance
- Duration: X min
- Tasks: 1 (TDD feature)
- Files created: N

## RED Phase
- Tests written for: [list]
- Initial failures: [expected/unexpected]

## GREEN Phase
- All tests passing
- Any bugs discovered: [list or None]

## REFACTOR Phase
- [Cleanup done or "None needed"]

## Commits
- [List commits with messages]

## Files Created
- tests/conftest.py - Basic fixtures
- tests/test_context_dto.py - merge_contexts tests
- tests/test_load_context_runnable.py - URL extraction tests
- tests/test_context_injection.py - Prompt formatting tests

## Next Step
Ready for 05-02-PLAN.md (context loader integration tests)
</output>
