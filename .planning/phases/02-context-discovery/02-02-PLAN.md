---
phase: 02-context-discovery
plan: 02
type: execute
---

<objective>
Wire context loading into the workflow and add CLI flags for context overrides.

Purpose: Complete the context discovery feature by integrating the loader into the analysis workflow and exposing CLI options.
Output: Updated workflow with context loading node, CLI flags for `--org-context` and `--repo-context`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/workflows/repo_type_workflow.py
@src/cli/discover.py
@src/nodes/runnables/load_context_runnable.py

**From Plan 01:**
- `src/services/context_loader.py` - Context loading functions
- `src/nodes/runnables/load_context_runnable.py` - Runnable for workflow

**Constraining decisions:**
- CLI flags `--org-context` and `--repo-context` for file path overrides
- Context loading happens after clone (needs local_path)
- Context should flow through entire workflow via state

**Established patterns:**
- Workflow uses LangGraph StateGraph with `.add_node()` and `.add_edge()`
- CLI uses Click decorators (`@click.option`)
- Config dict passed to workflow.invoke() for runtime options
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context loading to workflow</name>
  <files>src/workflows/repo_type_workflow.py</files>
  <action>
Modify `src/workflows/repo_type_workflow.py`:

1. Add import at top:
   `from src.nodes.runnables.load_context_runnable import load_context_runnable`

2. In `generate_repo_type_workflow()` function, add new node after clone_repo:
   `workflow.add_node("load_context", load_context_runnable)`

3. Update edges to insert load_context between clone and next step:
   - Find the edge from "clone_repo" to next node (likely "deployment_signals_detection")
   - Change it to: clone_repo → load_context → deployment_signals_detection

   This means:
   - Remove/update: `workflow.add_edge("clone_repo_tool", "deployment_signals_detection")`
   - Add: `workflow.add_edge("clone_repo_tool", "load_context")`
   - Add: `workflow.add_edge("load_context", "deployment_signals_detection")`

4. Ensure the workflow still compiles and the node ordering is correct.

The context will be loaded after clone (so local_path exists) and before any analysis nodes that might benefit from it.
  </action>
  <verify>uv run python -c "from src.workflows.repo_type_workflow import generate_repo_type_workflow; w = generate_repo_type_workflow(); print('Workflow compiles OK')"</verify>
  <done>Workflow includes load_context node after clone_repo, compiles without error</done>
</task>

<task type="auto">
  <name>Task 2: Add CLI flags for context overrides</name>
  <files>src/cli/discover.py</files>
  <action>
Modify `src/cli/discover.py`:

1. Add import at top:
   `from src.services.context_loader import build_discovery_context`

2. Add two new Click options to the `discover` command (after `--llm`):

   ```python
   @click.option(
       '--org-context',
       type=click.Path(exists=True, readable=True),
       help='Path to organization context file (overrides ~/.sbs-discovery/{org}.md)'
   )
   @click.option(
       '--repo-context',
       type=click.Path(exists=True, readable=True),
       help='Path to repository context file (overrides .sbs-discovery.md in repo)'
   )
   ```

3. Add parameters to function signature:
   `org_context: Optional[str], repo_context: Optional[str]`

4. Read override file contents if provided (before the repo loop):
   ```python
   org_context_override = None
   repo_context_override = None
   if org_context:
       org_context_override = Path(org_context).read_text(encoding="utf-8")
       console.print(f"[cyan]Using org context from:[/cyan] {org_context}")
   if repo_context:
       repo_context_override = Path(repo_context).read_text(encoding="utf-8")
       console.print(f"[cyan]Using repo context from:[/cyan] {repo_context}")
   ```

5. Pass overrides via workflow config (in the repo processing loop):
   Update the config dict to include context overrides:
   ```python
   config = {
       "configurable": {
           "model_name": llm,
           "org_context_override": org_context_override,
           "repo_context_override": repo_context_override,
       }
   }
   ```

6. Add `from pathlib import Path` import if not already present.

Note: The runnable will need to be updated to read these from config. That's a minor addition to the runnable.
  </action>
  <verify>uv run python -c "from src.cli.discover import discover; print('CLI imports OK')"</verify>
  <done>CLI has --org-context and --repo-context flags, help text displays correctly</done>
</task>

<task type="auto">
  <name>Task 3: Update runnable to accept config overrides</name>
  <files>src/nodes/runnables/load_context_runnable.py</files>
  <action>
Update `src/nodes/runnables/load_context_runnable.py` to accept config overrides:

1. Change function signature to accept config:
   `def load_context_runnable(state: RootRepoState, config: dict = None) -> RootRepoState:`

2. Extract overrides from config if provided:
   ```python
   org_override = None
   repo_override = None
   if config and "configurable" in config:
       org_override = config["configurable"].get("org_context_override")
       repo_override = config["configurable"].get("repo_context_override")
   ```

3. Pass overrides to `build_discovery_context()`:
   ```python
   context = build_discovery_context(
       org_name=org_name,
       local_path=state.local_path,
       org_context_override=org_override,
       repo_context_override=repo_override
   )
   ```

4. Log when overrides are used for debugging.

This allows CLI-provided context files to override the default discovery locations.
  </action>
  <verify>uv run python -c "from src.nodes.runnables.load_context_runnable import load_context_runnable; print('Runnable with config OK')"</verify>
  <done>Runnable accepts config parameter with context overrides</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Context discovery system with workflow integration and CLI flags</what-built>
  <how-to-verify>
    1. Create test context files:
       ```bash
       mkdir -p ~/.sbs-discovery
       echo "# Test Org Context\nThis is org-level context for testing." > ~/.sbs-discovery/test-org.md
       ```

    2. Verify CLI help shows new flags:
       ```bash
       uv run sbs-ai-discovery discover --help
       ```
       Confirm `--org-context` and `--repo-context` options appear.

    3. Test dry-run with verbose output (if available) or check logs:
       - The context loading should be visible in workflow execution
       - For full verification, run against a test repo with `.sbs-discovery.md` file

    4. Verify no regressions:
       - Running without context flags should work as before
       - Missing context files should not cause errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Workflow compiles with load_context node
- [ ] CLI shows --org-context and --repo-context in help
- [ ] Discover command runs without context (backward compatible)
- [ ] Context override flags accept file paths
- [ ] No import errors or runtime crashes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Workflow includes context loading step
- CLI exposes context override options
- System works with and without user-provided context
- Phase 2 complete, ready for Phase 3: Agent Integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-context-discovery/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Workflow & CLI Integration Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/workflows/repo_type_workflow.py` - Added load_context node
- `src/cli/discover.py` - Added --org-context and --repo-context flags
- `src/nodes/runnables/load_context_runnable.py` - Updated to accept config overrides

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 2 complete, ready for Phase 3: Agent Integration
</output>
